<!DOCTYPE html>
<html>
<head>
  <title></title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes" />

	<link rel="stylesheet" href="./css/animations.css">
	<link rel="stylesheet" href="./css/bootstrap.css" type="text/css">
	<link rel="stylesheet" href="./css/style.css" type="text/css">

</head>
<body>

	<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=252090111493728";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://wtf.fm" data-text="⍾ wtf.fm | the best fucking way to find new music via @jiggabits + @butchershopsf" data-hashtags="WTFfm">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>


<BR>

<div class="fb-like" data-href="http://wtf.fm" data-send="false" data-layout="button_count" data-width="100" data-show-faces="false"></div>
</div>


	<ul id="links">
		<li>
			<a href="http://soundcloud.com/jiggabits" target="_blank" id="soundcloud"></a> 
		</li>
		<li>
			<a href="http://www.99centbrains.com" target="_blank" id="centbrains" style="background-size: 100%"></a> 
		</li>
	</ul>

	<div id="container">

		<div class="row">
			<div class="jumbotron col-md-6 col-md-offset-3">
				<h1><div class="w pulse"></div> wtf.fm</h1>
				<p>Because you don't know what the fuck to listen to.</p>
			</div>
		</div>
	</div>


<div class="row colophon">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<ul id="controls">
			<li>
				<button id="playPause"><span class="glyphicon glyphicon-play"></span></button>
			</li>
			<li>
				<button id="shuffle" onclick="location.href='http://soundcloud.com/99centbrains'" target="_blank">
					<span class="glyphicon glyphicon-random"></span>
				</button>
			</li>
			<li class="nowPlaying">
				Now Playing:
			</li>
			<li class="trackInfo">
			</li>
		</ul>
	</div>

</div>

	    <script src="./js/jquery-1.11.0.min.js"></script>
		<script src="./js/bootstrap.js"></script>

		<script src="http://connect.soundcloud.com/sdk.js"></script>

		<script>

		/**
		Credit the uploader as the creator of the sound
		Credit SoundCloud as the source by including one of the logos found here
		Link to the SoundCloud URL containing the work
		If the sound is private link to the profile of the creator
		**/

	     /////// +++ LOCAL STORAGE +++ ////////
		supports_html5_storage =  function() {
		try {
		  return 'localStorage' in window && window['localStorage'] !== null;
		} catch (e) {
		  return false;
		}
		}

		supports_html5_storage();

		$(document).ready(function() {

			

			//get previously played tracks
			var lastTrack = JSON.parse(localStorage.getItem('last-played'));
			var oldeQueue = JSON.parse(localStorage.getItem('queue'));

			var time = localStorage.getItem('time');

			if (!lastTrack) {
				refreshPlaylist();
			  } else {

			  	var track = new Track(lastTrack);

			  	stream(lastTrack.uri, oldeQueue, time);
			  	//displayTracks(oldeQueue);
			  	setView(lastTrack);
			  }
		});



















		// initialize client with app credentials
		SC.initialize({
		  client_id: 'ba6d3bde0a8e5030d641e141cc357fdf',
		  redirect_uri: 'http://localhost:8888/callback.html'
		});

		//99centbrains user id is: 33178966

		/**SC.connect(function() {
		  SC.get('/me/activities', function(activities) { 
		   console.log(activities); 
		  });
		});**/

		//search by username?
		

		function Track(track) {

			this.artist = track.user.username;
			this.title = track.title;
			this.uri = track.uri;
			this.link = track.permalink_url;
		
		}

		function refreshPlaylist() {

			SC.get('/users/33178966/favorites', function(tracks) {
					console.log('starting tracks is: ' + tracks.length);
					$(tracks).each( function(i) {

						//gets rid of any tracks that
						//are not streamable.
						if(!this.streamable) {
							tracks.splice(i, 1);
						}

					})

					set(tracks);

					//displayTracks(tracks);


				});
		}


		function displayTracks(tracks) {

		}


		//+ Jonas Raoni Soares Silva
		//@ http://jsfromhell.com/array/shuffle [v1.0]
		function shuffle(o){ //v1.0
		    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
		    return o;
		};

		function set(tracks) {

			$(tracks).each( function() {
			
			})

			var shuffled = shuffle(tracks);

			var index = shuffled.shift();
			
			//save to localStorage
			localStorage.setItem('last-played', JSON.stringify(index));
			localStorage.setItem('queue', JSON.stringify(tracks));

			//start streaming
			stream(index.uri, tracks);
			setView(index);

		}



		var stream = function(track, queue, time) {

			SC.stream(track, {

				onfinish: function() { 
					this.destruct();
					checkQueue(queue);
				}

			}, function(sound) {

				sound.play( {

					position: time,

					whileplaying: function() {
						localStorage.setItem('time', this.position);
					},

					whileloading: function() {
						//console.log('loading...');
					}
				});
				bindButtons(sound);

			});

		}

		function setView(track) {

			var source = $('#track-template').html();
			var template = Handlebars.compile(source);

			var permalink_url = track.permalink_url;
			
			var icon = (!track.artwork_url) ? './img/m.png' : track.artwork_url;
			
			var username = track.user.username;
			var title = track.title;

			var context = {permalink_url: permalink_url, icon: icon, username: username, title: title}

			var html = template(context);

			$('li.trackInfo').html(html);
		}

		function checkQueue(queue) {
			if(queue.length === 0) {
				refreshPlaylist();
			} else {
				set(queue);
			}
		}

		function bindButtons(track) {

			$('#playPause').click( function() {
				track.togglePause();
				toggleControls(track);
			});

			//use spacebar to togglePause()
			$(document).keypress(function(e) {
				if ((e.which && e.which == 32) || (e.keyCode && e.keyCode == 32)) {  
					track.togglePause();
					toggleControls(track);
				}
			});

		}

		function toggleControls(track) {
			if(track.paused) {
				$('#playPause > span').removeClass('glyphicon-play').addClass('glyphicon-pause');
			} else {
				$('#playPause > span').removeClass('glyphicon-pause').addClass('glyphicon-play');
			}
		}

		</script>

		<!--** BACKGROUND SHIT**-->
		<script>
		$(function() {

			$.ajax({
				url: 'http://api.tumblr.com/v2/blog/gifyogurt.tumblr.com/posts?api_key=e5HGO63pDqbzDDpoVmGK2NVk83iDCSI0CynLzKhRlMmM4dUSmd&tag=fabstract',
				dataType: 'jsonp',
				success: function(data) {
					var posts = data.response.posts;

					var allBackgrounds = [];

					for (i = 0; i < posts.length; i++) {
						var photos = posts[i]['photos'];

						allBackgrounds.push(photos[0]['alt_sizes'][0]['url']);

						$(photos[0]['alt_sizes']).each( function() {
							//console.log(this.url);
						})

					}

					var background = allBackgrounds[Math.floor(Math.random()*allBackgrounds.length)];

					console.log(background);

					$('body').css('background', 'url("' + background + '")');
					$('body').css('background-repeat', 'repeat');
					$('body').css('background-position', 'center');


				}
			});
		})

		</script>

		<!-- ** TEMPLATE SHIT ** -->
		<script src="./js/handlebars-v1.3.0.js"></script>
		<script id="track-template" type="text/x-handlebars-template">
			<a class="pull-left" href="{{permalink_url}}">
				<div class="media">
				    <img class="media-object" src="{{icon}}" alt="{{title}}">
				  <div class="media-body">
				    <h4 class="media-heading">{{username}} - {{title}}</h4>
				  </div>
				</div>
			</a>
		</script>

</body>
</html>